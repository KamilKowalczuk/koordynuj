---
// src/components/sections/Process.astro - WERSJA Z POPRAWIONYMI DANYMI ZAPASOWYMI
import AnimateOnScroll from '../ui/AnimateOnScroll.astro';
import InteractiveTimeline from '../ui/InteractiveTimeline.svelte';
import { getProcessSteps } from '../../lib/strapi';

let steps = await getProcessSteps();

// Przetwarzamy pole 'details' z JSON na tablicę
if (steps && steps.length > 0) {
    steps = steps.map(step => {
        let parsedDetails = [];
        if (step.details && typeof step.details === 'string') {
            try {
                parsedDetails = JSON.parse(step.details);
            } catch (e) {
                console.error(`Błąd parsowania pola 'details' dla kroku "${step.title}":`, e);
            }
        } else if (Array.isArray(step.details)) {
            parsedDetails = step.details;
        }
        return { ...step, details: parsedDetails };
    });
} else {
    // KROK 1: Dodajemy brakujące pole 'order' do danych zapasowych
    steps = [
        { 
            id: 1,
            title: "Audyt i Strategia", 
            description: "<p>Analizujemy Twoją placówkę, identyfikujemy potencjał i tworzymy dedykowany plan działania.</p>",
            details: ["Kompleksowa analiza...", "Identyfikacja obszarów...", "Opracowanie strategii..."],
            duration: "2-3 tygodnie",
            icon: "audit",
            order: 1 // DODANE
        },
        { 
            id: 2,
            title: "Wdrożenie i Szkolenia", 
            description: "<p>Implementujemy narzędzia, procedury i szkolimy personel, aby zapewnić płynne przejęcie nowych obowiązków.</p>",
            details: ["Wdrożenie procedur...", "Szkolenia dla personelu...", "Wsparcie wdrożeniowe..."],
            duration: "4-6 tygodni",
            icon: "implementation",
            order: 2 // DODANE
        },
        { 
            id: 3,
            title: "Ciągłe Wsparcie i Rozwój", 
            description: "<p>Monitorujemy wyniki, optymalizujemy procesy i zapewniamy bieżące wsparcie prawne i organizacyjne.</p>",
            details: ["Regularne monitorowanie...", "Ciągła optymalizacja...", "Bieżące wsparcie..."],
            duration: "Ciągle",
            icon: "support",
            order: 3 // DODANE
        }
    ];
}
---

<section id="proces" class="py-20 sm:py-32 bg-background-light relative">
    <div class="absolute inset-0 opacity-[0.02] pointer-events-none">
        <div class="process-bg-pattern absolute inset-0"></div>
    </div>
    <div class="absolute inset-0 opacity-5">
        <svg class="w-full h-full" viewBox="0 0 1200 800">
            <defs>
                <marker id="arrowhead-process" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#00A9E0" opacity="0.3"/>
                </marker>
            </defs>
            <path d="M100,400 Q400,350 800,400 Q1000,420 1100,400" stroke="#00A9E0" stroke-width="2" fill="none" opacity="0.2" class="animate-process-flow"/>
            <circle cx="200" cy="380" r="4" fill="#00A9E0" opacity="0.3" class="animate-pulse-process"/>
            <circle cx="600" cy="410" r="4" fill="#00A9E0" opacity="0.3" class="animate-pulse-process-delay"/>
            <circle cx="1000" cy="405" r="4" fill="#00A9E0" opacity="0.3" class="animate-pulse-process-delay-2"/>
        </svg>
    </div>

    <AnimateOnScroll>
        <div class="relative z-10 max-w-5xl mx-auto px-4">
            <div class="text-center mb-16">
                <h2 class="text-4xl md:text-5xl font-extrabold text-text-primary mb-4 tracking-tighter">
                    Trzy kroki do pełnej optymalizacji.
                </h2>
                <p class="text-lg text-text-muted max-w-3xl mx-auto">
                    Nasz sprawdzony proces zapewnia systematyczne wdrożenie zmian i osiągnięcie mierzalnych rezultatów w każdej placówce.
                </p>
            </div>

            <div>
                {/* Krok 5: Przekazujemy dynamicznie załadowane i przetworzone dane */}
                <InteractiveTimeline {steps} client:load />
            </div>

            <div class="mt-16">
                <div class="cta-card bg-gradient-to-r from-brand-blue/5 to-background-muted p-8 rounded-2xl transition-all duration-500 hover:shadow-lg hover:shadow-brand-blue/5 hover:from-brand-blue/8 hover:to-background-muted relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-brand-blue/10 to-transparent rounded-full transform translate-x-16 -translate-y-16"></div>
                    <div class="text-center relative z-10">
                        <h3 class="text-xl font-semibold text-text-primary mb-4 group-hover:text-brand-blue/90 transition-colors duration-300">
                            Gotowy na efektywności Twojej placówki?
                        </h3>
                        <p class="text-text-muted mb-6">
                            Pierwsza konsultacja jest <span class="font-semibold text-brand-blue">bezpłatna</span>. 
                            Ocenimy potencjał Twojej placówki i przedstawimy konkretny plan działania.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                            <a href="#kontakt" class="btn-primary inline-flex items-center group">
                                Zacznijmy współpracę
                                <svg class="ml-2 w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                </svg>
                            </a>
                            <div class="flex items-center text-text-muted time-guarantee">
                                <svg class="w-5 h-5 mr-2 text-brand-blue transition-transform hover:rotate-12 duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Odpowiedź w ciągu 24h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </AnimateOnScroll>
</section>

<style>
    .cta-card {
        position: relative;
        cursor: default;
    }
    .cta-card::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(0, 169, 224, 0.02), transparent);
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    .cta-card:hover::before {
        opacity: 1;
    }
    .process-bg-pattern {
        background-image: 
            radial-gradient(circle at 25% 20%, rgba(0, 169, 224, 0.12) 1px, transparent 1px),
            radial-gradient(circle at 75% 80%, rgba(0, 169, 224, 0.08) 1px, transparent 1px),
            radial-gradient(circle at 50% 50%, rgba(0, 169, 224, 0.10) 1px, transparent 1px);
        background-size: 150px 150px, 200px 200px, 175px 175px;
        animation: patternDrift 30s linear infinite;
    }
    .btn-primary {
        position: relative;
        overflow: hidden;
    }
    .time-guarantee:hover .text-brand-blue {
        animation: clockTick 1s ease-in-out;
    }
    @keyframes process-flow {
        from { stroke-dasharray: 1200; stroke-dashoffset: 1200; }
        to { stroke-dasharray: 1200; stroke-dashoffset: 0; }
    }
    @keyframes pulse-process {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.3); }
    }
    .animate-process-flow { 
        animation: process-flow 4s ease-out 0.5s forwards; 
        stroke-dasharray: 1200; 
        stroke-dashoffset: 1200; 
    }
    .animate-pulse-process { animation: pulse-process 3s ease-in-out infinite; }
    .animate-pulse-process-delay { animation: pulse-process 3s ease-in-out infinite 1s; }
    .animate-pulse-process-delay-2 { animation: pulse-process 3s ease-in-out infinite 2s; }
    @keyframes patternDrift {
        0% { background-position: 0% 0%, 0% 0%, 0% 0%; }
        100% { background-position: 100% 100%, -100% 100%, 50% -100%; }
    }
    @keyframes clockTick {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-15deg); }
        75% { transform: rotate(15deg); }
    }
    @media (prefers-reduced-motion: reduce) {
        .cta-card, .process-bg-pattern, .btn-primary, .time-guarantee,
        .animate-process-flow, .animate-pulse-process, .animate-pulse-process-delay, .animate-pulse-process-delay-2 {
            animation: none !important;
            transition: none !important;
        }
    }
    @media (max-width: 768px) {
        .process-bg-pattern { display: none; }
    }
</style>